---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
  namespace: security
spec:
  interval: 1h
  chart:
    spec:
      chart: authentik
      version: 2025.1.2
      sourceRef:
        kind: HelmRepository
        name: authentik
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    # Authentik configuration
    authentik:
      # Secret key for signing and encryption
      secret_key:
        valueFrom:
          secretKeyRef:
            name: authentik-secrets
            key: secret-key
      
      # Error reporting and telemetry
      error_reporting:
        enabled: false
        send_pii: false
      
      # Bootstrap configuration
      bootstrap:
        password:
          valueFrom:
            secretKeyRef:
              name: authentik-secrets
              key: bootstrap-token
        email: "admin@rutberg.dev"
        token:
          valueFrom:
            secretKeyRef:
              name: authentik-secrets
              key: bootstrap-token

      # PostgreSQL database configuration
      postgresql:
        host: "authentik-postgresql"
        port: 5432
        name: "authentik"
        user: "authentik"
        password:
          valueFrom:
            secretKeyRef:
              name: authentik-secrets
              key: postgres-password

      # Redis configuration
      redis:
        host: "authentik-redis"
        port: 6379
        password:
          valueFrom:
            secretKeyRef:
              name: authentik-secrets
              key: redis-password

      # Email configuration (optional)
      email:
        host:
          valueFrom:
            secretKeyRef:
              name: authentik-secrets
              key: smtp-host
        port:
          valueFrom:
            secretKeyRef:
              name: authentik-secrets
              key: smtp-port
        username:
          valueFrom:
            secretKeyRef:
              name: authentik-secrets
              key: smtp-username
        password:
          valueFrom:
            secretKeyRef:
              name: authentik-secrets
              key: smtp-password
        from:
          valueFrom:
            secretKeyRef:
              name: authentik-secrets
              key: smtp-from
        use_tls:
          valueFrom:
            secretKeyRef:
              name: authentik-secrets
              key: smtp-use-tls
        use_ssl:
          valueFrom:
            secretKeyRef:
              name: authentik-secrets
              key: smtp-use-ssl

    # Server configuration
    server:
      replicas: 2
      resources:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: 500m
          memory: 1Gi
      
      # Probes
      livenessProbe:
        httpGet:
          path: /-/health/live/
          port: http
        initialDelaySeconds: 30
        periodSeconds: 30
      readinessProbe:
        httpGet:
          path: /-/health/ready/
          port: http
        initialDelaySeconds: 15
        periodSeconds: 10

      # Service configuration
      service:
        type: ClusterIP
        port: 80
        annotations: {}

      # Ingress configuration (disabled - we'll create our own)
      ingress:
        enabled: false

    # Worker configuration
    worker:
      replicas: 1
      resources:
        requests:
          cpu: 50m
          memory: 256Mi
        limits:
          cpu: 300m
          memory: 512Mi

    # Persistence - disabled since we use external PostgreSQL
    postgresql:
      enabled: false
    
    redis:
      enabled: false

    # Security context
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000

    # Pod disruption budget
    podDisruptionBudget:
      enabled: true
      minAvailable: 1